---
title: Masking and filtering
sidebarTitle: Masking & filtering
description: Mask sensitive data and exclude requests from logging with the Apitally SDK for JavaScript.
---

import DefaultMaskingAndExclusion from '/snippets/default-masking-and-exclusion.mdx';

When request logging is enabled, the Apitally SDK captures details about each request and response handled by your application. To protect sensitive data and reduce noise, the SDK provides mechanisms for masking data and filtering out requests you don't want to log.


## Default masking and exclusion

<DefaultMaskingAndExclusion />

## Mask sensitive data

You can extend the default masking rules by providing additional regular expressions via the `maskQueryParams`, `maskHeaders`, and `maskBodyFields` parameters. Patterns match anywhere within the name. Use `^` and `$` anchors for exact matches, and the `i` flag for case-insensitive matching.

For more control over request and response body masking, you can provide callback functions via the `maskRequestBodyCallback` and `maskResponseBodyCallback` parameters. The functions receive the captured request and response data as arguments (see [callback arguments](#callback-arguments) below) and should return the masked body as `Buffer`, or `null` to mask the entire body.

<CodeGroup>
  ```javascript Hono example {14-20}
  import { Hono } from "hono";
  import { useApitally } from "apitally/hono";

  const app = new Hono();

  useApitally(app, {
    clientId: "your-client-id",
    env: "dev",
    requestLogging: {
      enabled: true,
      logRequestHeaders: true,
      logRequestBody: true,
      logResponseBody: true,
      // Mask specific query parameters, headers and body fields
      maskQueryParams: [/^card_number$/i, /^account_id$/i],
      maskHeaders: [/^X-Custom-Key$/i, /^X-Internal-/i],
      maskBodyFields: [/^credit_card$/i, /social_security/i],
      // Mask request and response body using custom logic (see examples below)
      maskRequestBodyCallback: maskRequestBody,
      maskResponseBodyCallback: maskResponseBody,
    },
  });
  ```

  ```javascript NestJS example {16-22}
  import { NestFactory } from "@nestjs/core";
  import { useApitally } from "apitally/nestjs";
  import { AppModule } from "./app.module";

  async function bootstrap() {
    const app = await NestFactory.create(AppModule);

    await useApitally(app, {
      clientId: "your-client-id",
      env: "dev",
      requestLogging: {
        enabled: true,
        logRequestHeaders: true,
        logRequestBody: true,
        logResponseBody: true,
        // Mask specific query parameters, headers and body fields
        maskQueryParams: [/^card_number$/i, /^account_id$/i],
        maskHeaders: [/^X-Custom-Key$/i, /^X-Internal-/i],
        maskBodyFields: [/^credit_card$/i, /social_security/i],
        // Mask request and response body using custom logic (see examples below)
        maskRequestBodyCallback: maskRequestBody,
        maskResponseBodyCallback: maskResponseBody,
      },
    });
  }
  ```

  ```javascript Express example {14-20}
  import express from "express";
  import { useApitally } from "apitally/express";

  const app = express();

  useApitally(app, {
    clientId: "your-client-id",
    env: "dev",
    requestLogging: {
      enabled: true,
      logRequestHeaders: true,
      logRequestBody: true,
      logResponseBody: true,
      // Mask specific query parameters, headers and body fields
      maskQueryParams: [/^card_number$/i, /^account_id$/i],
      maskHeaders: [/^X-Custom-Key$/i, /^X-Internal-/i],
      maskBodyFields: [/^credit_card$/i, /social_security/i],
      // Mask request and response body using custom logic (see examples below)
      maskRequestBodyCallback: maskRequestBody,
      maskResponseBodyCallback: maskResponseBody,
    },
  });
  ```

  ```javascript Fastify example {14-20}
  import Fastify from "fastify";
  import { apitallyPlugin } from "apitally/fastify";

  const fastify = Fastify({ logger: true });

  await fastify.register(apitallyPlugin, {
    clientId: "your-client-id",
    env: "dev",
    requestLogging: {
      enabled: true,
      logRequestHeaders: true,
      logRequestBody: true,
      logResponseBody: true,
      // Mask specific query parameters, headers and body fields
      maskQueryParams: [/^card_number$/i, /^account_id$/i],
      maskHeaders: [/^X-Custom-Key$/i, /^X-Internal-/i],
      maskBodyFields: [/^credit_card$/i, /social_security/i],
      // Mask request and response body using custom logic (see examples below)
      maskRequestBodyCallback: maskRequestBody,
      maskResponseBodyCallback: maskResponseBody,
    },
  });
  ```
</CodeGroup>

```javascript Callback function examples
function maskRequestBody(request) {
  // Mask entire request body for admin endpoints
  if (request.path?.startsWith("/admin/")) {
    return null;
  }
  // Otherwise, return the original request body
  return request.body;
}

function maskResponseBody(request, response) {
  // Mask entire response body for admin endpoints
  if (request.path?.startsWith("/admin/")) {
    return null;
  }
  // Mask specific fields in user profile responses
  if (request.path?.startsWith("/users/") && response.body) {
    try {
      const data = JSON.parse(response.body.toString());
      if (typeof data === "object" && data !== null) {
        if ("email" in data) {
          data.email = "******";
        }
        if ("phone" in data) {
          data.phone = "******";
        }
        return Buffer.from(JSON.stringify(data));
      }
    } catch {
      // If parsing fails, return original body
    }
  }
  // Otherwise, return the original response body
  return response.body;
}
```

<Note>
  Callbacks are applied before pattern-based field masking. The returned body is still masked using the default and custom `maskBodyFields` patterns.
</Note>

## Exclude requests

You can exclude requests from logging using path patterns (regular expressions) via the `excludePaths` parameter. Like the masking patterns, these match anywhere within the request path. Use `^` and `$` anchors for exact matches, and the `i` flag for case-insensitive matching.

Alternatively, you can provide a callback function with custom exclusion logic via the `excludeCallback` parameter. The function receives the captured request and response data as arguments (see [callback arguments](#callback-arguments) below) and should return `true` to exclude the request from logging, or `false` to include it.

<CodeGroup>
  ```javascript Hono example {11-14}
  import { Hono } from "hono";
  import { useApitally } from "apitally/hono";

  const app = new Hono();

  useApitally(app, {
    clientId: "your-client-id",
    env: "dev",
    requestLogging: {
      enabled: true,
      // Exclude paths matching certain patterns
      excludePaths: [/\/admin\//i, /\/internal\//i],
      // Exclude requests using custom logic (see example below)
      excludeCallback: excludeRequest,
    },
  });
  ```

  ```javascript NestJS example {13-16}
  import { NestFactory } from "@nestjs/core";
  import { useApitally } from "apitally/nestjs";
  import { AppModule } from "./app.module";

  async function bootstrap() {
    const app = await NestFactory.create(AppModule);

    await useApitally(app, {
      clientId: "your-client-id",
      env: "dev",
      requestLogging: {
        enabled: true,
        // Exclude paths matching certain patterns
        excludePaths: [/\/admin\//i, /\/internal\//i],
        // Exclude requests using custom logic (see example below)
        excludeCallback: excludeRequest,
      },
    });
  }
  ```

  ```javascript Express example {11-14}
  import express from "express";
  import { useApitally } from "apitally/express";

  const app = express();

  useApitally(app, {
    clientId: "your-client-id",
    env: "dev",
    requestLogging: {
      enabled: true,
      // Exclude paths matching certain patterns
      excludePaths: [/\/admin\//i, /\/internal\//i],
      // Exclude requests using custom logic (see example below)
      excludeCallback: excludeRequest,
    },
  });
  ```

  ```javascript Fastify example {11-14}
  import Fastify from "fastify";
  import { apitallyPlugin } from "apitally/fastify";

  const fastify = Fastify({ logger: true });

  await fastify.register(apitallyPlugin, {
    clientId: "your-client-id",
    env: "dev",
    requestLogging: {
      enabled: true,
      // Exclude paths matching certain patterns
      excludePaths: [/\/admin\//i, /\/internal\//i],
      // Exclude requests using custom logic (see example below)
      excludeCallback: excludeRequest,
    },
  });
  ```
</CodeGroup>

```javascript Callback function example
function excludeRequest(request, response) {
  // Exclude requests from a specific consumer
  if (request.consumer === "internal-service") {
    return true;
  }
  // Exclude successful requests (only log failures)
  if (response.statusCode < 400) {
    return true;
  }
  return false;
}
```

<Note>
  Excluded requests won't be logged, but are still counted in metrics. To exclude endpoints from metrics, you can mark them as excluded in the [dashboard](/api-metrics/traffic#exclude-endpoints).
</Note>

## Callback arguments

The `request` object passed to callback functions has the following properties:

| Property | Description | Type |
| :------- | :---------- | :--- |
| `timestamp` | Unix timestamp of the request. | `number` |
| `method` | HTTP method of the request. | `string` |
| `path` | Path of the matched endpoint, if applicable. | `string \| undefined` |
| `url` | Full URL of the request. | `string` |
| `headers` | Array of key-value pairs representing the request headers. | `[string, string][]` |
| `size` | Size of the request body in bytes. | `number \| undefined` |
| `consumer` | Identifier of the consumer making the request. | `string \| undefined` |
| `body` | Raw request body. | `Buffer \| undefined` |

The `response` object passed to `maskResponseBodyCallback` and `excludeCallback` has the following properties:

| Property | Description | Type |
| :------- | :---------- | :--- |
| `statusCode` | HTTP status code of the response. | `number` |
| `responseTime` | Time taken to respond to the request in seconds. | `number` |
| `headers` | Array of key-value pairs representing the response headers. | `[string, string][]` |
| `size` | Size of the response body in bytes. | `number \| undefined` |
| `body` | Raw response body. | `Buffer \| undefined` |
